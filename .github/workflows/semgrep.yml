name: Semgrep

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  semgrep:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: List PHP files
        run: |
          echo "Repo root: $PWD"
          find . -type f -name "*.php" | head -n 200
          echo "Total PHP files:" 
          find . -type f -name "*.php" | wc -l

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Semgrep & jq
        run: |
          pip install --upgrade pip semgrep
          sudo apt-get update && sudo apt-get install -y jq

      - name: Prepare config & reports dir
        shell: bash
        run: |
          set -euo pipefail

          # ì•ˆì „ ì´ˆê¸°í™”
          CONFIG_FILES=""

          # í•­ìƒ ë‘ ê°œì˜ ë¡œì»¬ íŒŒì¼ì„ ìš°ì„  ì¶”ê°€ (ìžˆìœ¼ë©´)
          [ -f ".semgrep/packs-only.yml" ] && CONFIG_FILES+="--config .semgrep/packs-only.yml "
          [ -f ".semgrep/local-rules.yml" ] && CONFIG_FILES+="--config .semgrep/local-rules.yml "

          # fallback: ê¸°ì¡´ ë‹¨ì¼ í†µí•© íŒŒì¼ ë˜ëŠ” default packs
          if [ -z "$CONFIG_FILES" ]; then
            if [ -f ".semgrep/.semgrep.yml" ]; then
              CONFIG_FILES="--config .semgrep/.semgrep.yml "
            elif [ -f ".semgrep.yml" ]; then
              CONFIG_FILES="--config .semgrep.yml "
            else
              CONFIG_FILES="--config p/php --config p/javascript "
            fi
          fi

          # trim trailing whitespace
          CONFIG_FILES="$(echo -n "$CONFIG_FILES" | sed -e 's/[[:space:]]*$//')"

          # export for later steps
          echo "CONFIG_FILES=$CONFIG_FILES" >> "$GITHUB_ENV"

          # prepare reports dir
          mkdir -p reports

          # debug output
          echo "== CONFIG_FILES chosen =="
          echo "$CONFIG_FILES"
          echo "== List .semgrep dir (if any) =="
          ls -la .semgrep || true
          [ -f ".semgrep/packs-only.yml" ] && echo "---- packs-only head ----" && sed -n '1,80p' .semgrep/packs-only.yml || true
          [ -f ".semgrep/local-rules.yml" ] && echo "---- local-rules head ----" && sed -n '1,80p' .semgrep/local-rules.yml || true

      - name: Normalize .semgrep rule files (remove BOM / ensure UTF-8)
        shell: bash
        run: |
          set -euo pipefail
          if [ -d ".semgrep" ]; then
            for f in .semgrep/*.yml; do
              [ -f "$f" ] || continue
              sed -i '1s/^\xEF\xBB\xBF//' "$f"
            done
          fi

      - name: Semgrep debug run (capture stdout/stderr)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p reports debug_out
          echo "CONFIG_FILES='$CONFIG_FILES'"
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          export PYTHONUTF8=1

          # run semgrep capturing debug (don't fail step on non-zero so we can inspect logs)
          semgrep scan $CONFIG_FILES --metrics=off --timeout 120 --json -o reports/semgrep.json --sarif -o reports/semgrep.sarif --debug > debug_out/semgrep.out 2> debug_out/semgrep.err || true

          echo "---- semgrep.out (tail 200) ----"
          tail -n 200 debug_out/semgrep.out || true
          echo "---- semgrep.err (tail 200) ----"
          tail -n 200 debug_out/semgrep.err || true

          echo "reports directory listing:"
          ls -la reports || true
          echo "reports/semgrep.json exists?:" $( [ -f reports/semgrep.json ] && echo yes || echo no )
          echo "reports/semgrep.sarif exists?:" $( [ -f reports/semgrep.sarif ] && echo yes || echo no )

      - name: Validate JSON & quick summary
        shell: bash
        run: |
          set -euo pipefail
          if [ -s reports/semgrep.json ] && jq empty reports/semgrep.json 2>/dev/null; then
            echo "semgrep.json is valid JSON"
            echo "Total findings: $(jq '.results | length // 0' reports/semgrep.json)"
          else
            echo "reports/semgrep.json missing or invalid; check debug_out/semgrep.err"
          fi

      - name: Write Enhanced Markdown Summary
        shell: bash
        run: |
          set -euo pipefail
          echo "## ðŸ§ª Semgrep Summary" >> "$GITHUB_STEP_SUMMARY"

          if [ -s reports/semgrep.json ] && jq empty reports/semgrep.json 2>/dev/null; then
            TOTAL=$(jq '.results | length // 0' reports/semgrep.json)
            echo "- Total findings: **$TOTAL**" >> "$GITHUB_STEP_SUMMARY"

            # Severity counts
            for sev in ERROR WARNING INFO; do
              COUNT=$(jq --arg sev "$sev" '[.results[] | select(.extra.severity==$sev)] | length' reports/semgrep.json)
              echo "  - $sev: **$COUNT**" >> "$GITHUB_STEP_SUMMARY"
            done

            # Top 5 per severity
            for sev in ERROR WARNING INFO; do
              echo -e "\n### Top $sev findings (up to 5 per severity)\n" >> "$GITHUB_STEP_SUMMARY"
              jq -r --arg sev "$sev" '
                .results
                | map(select(.extra.severity == $sev))[:5][]
                | "| \(.extra.severity) | \(.check_id) | \(.path):\(.start.line) | \(.extra.message | gsub("\n"; " ")) |"
              ' reports/semgrep.json >> "$GITHUB_STEP_SUMMARY"
            done

            # Critical patterns (SQLi / XSS / RCE)
            echo -e "\n### ðŸ”¥ Critical WP Vulnerabilities (SQLi, XSS, RCE, up to 10)\n" >> "$GITHUB_STEP_SUMMARY"
            jq -r '
              .results
              | map(select(.check_id | test("wp-sqli|wp-xss|wp-command-injection")))[:10][]
              | "| \(.extra.severity) | \(.check_id) | \(.path):\(.start.line) | \(.extra.message | gsub("\n"; " ")) |"
            ' reports/semgrep.json >> "$GITHUB_STEP_SUMMARY"

            # Findings grouped by file (compact)
            echo -e "\n### ðŸ“‚ Findings grouped by file (top 5 files)\n" >> "$GITHUB_STEP_SUMMARY"
            jq -r '
              .results
              | group_by(.path)
              | sort_by(- (length))            # íŒŒì¼ë³„ ê²°ê³¼ ë§Žì€ ìˆœ
              | .[:5]                          # ìƒìœ„ 5ê°œ íŒŒì¼ë§Œ
              | .[]
              | "#### File: \(. [0].path)"
              , (.[] | "| \(.extra.severity) | \(.check_id) | \(.start.line) | \(.extra.message | gsub("\n"; " ")) |")
            ' reports/semgrep.json >> "$GITHUB_STEP_SUMMARY"

          else
            echo "- Semgrep produced no JSON (likely no matching files). Check the PHP file listing step." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload SARIF if exists
        if: always()
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # find sarif (explicit path preferred)
          if [ -f reports/semgrep.sarif ]; then
            SARIF_FILE="reports/semgrep.sarif"
          else
            SARIF_FILE=$(find reports -maxdepth 1 -type f -name '*.sarif' | head -n 1 || true)
          fi

          if [ -n "$SARIF_FILE" ] && [ -f "$SARIF_FILE" ]; then
            echo "Uploading SARIF to GitHub code scanning: $SARIF_FILE"
            gh api --method POST -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/code-scanning/sarifs \
              -F "sarif=@${SARIF_FILE}" \
              -F "commit_sha=${{ github.sha }}" || true
          else
            echo "No SARIF file found â€” skipping upload"
            ls -la reports || true
          fi

      - name: Upload reports as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: reports/*, debug_out/*
          if-no-files-found: warn
          retention-days: 14
