name: Semgrep

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  semgrep:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # (ë””ë²„ê·¸) ì‹¤ì œë¡œ ì–´ë–¤ PHP íŒŒì¼ì„ ìŠ¤ìº”í•˜ëŠ”ì§€ ë³´ì—¬ì£¼ê¸°
      - name: List PHP files
        run: |
          echo "Repo root: $PWD"
          find . -type f -name "*.php" | head -n 200
          echo "Total PHP files:"
          find . -type f -name "*.php" | wc -l

      # Semgrep ì„¤ì¹˜ (Cloud í† í° ì—†ì´ CLIë¡œ ê³ ì •)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install Semgrep & jq
        run: |
          pip install --upgrade pip semgrep
          sudo apt-get update && sudo apt-get install -y jq

      # ìŠ¤ìº” ì‹¤í–‰: JSON + SARIF ë™ì‹œ ìƒì„± (ì•ŒëŸ¿ ì—†ì–´ë„ ì„±ê³µ ì¢…ë£Œ)
      - name: Run Semgrep (JSON + SARIF)
        run: |
          # .semgrep.yml ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ auto
          if [ -f ".semgrep.yml" ]; then
            CONFIG="--config .semgrep.yml"
          else
            CONFIG="--config p/php --config p/security-audit --config p/secrets"
          fi

          mkdir -p reports

          # --error ëŠ” â€˜ì•ŒëŸ¿ ìˆì„ ë•Œ ì‹¤íŒ¨â€™ë¼ ì§€ê¸ˆì€ ì œê±° (ë¦¬í¬íŠ¸ë§Œ ë§Œë“¤ê¸°)
          semgrep $CONFIG \
            --metrics=off \
            --timeout 10 \
            --json --output reports/semgrep.json \
            --sarif --output reports/semgrep.sarif || true

      # GitHub Actions Job Summary(ëŸ° ë¡œê·¸ ìœ„ ìƒë‹¨)ì— í•­ìƒ ìš”ì•½ ì“°ê¸°
      - name: Write Markdown Summary
        if: always()
        run: |
          echo "## ğŸ§ª Semgrep Summary" >> $GITHUB_STEP_SUMMARY

          if [ -s reports/semgrep.json ]; then
            TOTAL=$(jq '.results | length' reports/semgrep.json)
            echo "- Total findings: **$TOTAL**" >> $GITHUB_STEP_SUMMARY

            # ì‹¬ê°ë„ë³„ ì§‘ê³„ (ì—†ìœ¼ë©´ 0)
            for sev in ERROR WARNING INFO; do
              COUNT=$(jq --arg sev "$sev" '[.results[] | select(.extra.severity==$sev)] | length' reports/semgrep.json)
              echo "  - $sev: **$COUNT**" >> $GITHUB_STEP_SUMMARY
            done

            # ìƒìœ„ 10ê°œ ë£°/íŒŒì¼ ë¯¸ë‹ˆ í…Œì´ë¸”
            echo -e "\n### Top findings\n" >> $GITHUB_STEP_SUMMARY
            jq -r '
              .results[]
              | {check_id, path: .path, start: .start.line, message: .extra.message, severity: .extra.severity}
              | "| \(.severity) | \(.check_id) | \(.path):\(.start) | \(.message | gsub("\\n"; " ")) |"
            ' reports/semgrep.json | head -n 10 >> $GITHUB_STEP_SUMMARY

            echo -e "\n_(showing up to 10)_\n" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Semgrep produced no JSON (likely no files matched). Check the **List PHP files** step above." >> $GITHUB_STEP_SUMMARY
          fi

      # Code Scanningì— SARIF ì—…ë¡œë“œ (ì•ŒëŸ¿ 0ì´ì–´ë„ ì—…ë¡œë“œ ì‹œë„)
      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/semgrep.sarif

      # ë¦¬í¬íŠ¸ íŒŒì¼ ë³´ì¡´(ë‹¤ìš´ë¡œë“œìš©)
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: reports/*
          if-no-files-found: warn
          retention-days: 14
